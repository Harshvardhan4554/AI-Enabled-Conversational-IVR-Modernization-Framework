<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>IVR â€” Harshvardhan Patil</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
  @font-face{
    font-family:InterVar; src: local('Inter'), local('Inter var'); font-display:swap;
  }
  :root{
    --bg1: #0f1724;
    --bg2: #0b1230;
    --panel: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --accent: #5ef3c9;
    --accent-2: #7a6cff;
    --muted: rgba(255,255,255,0.6);
    --glass-border: rgba(255,255,255,0.06);
    --neon-shadow: 0 6px 24px rgba(122,108,255,0.12), 0 2px 8px rgba(94,243,201,0.06);
  }
  *{box-sizing:border-box;padding:0;margin:0;font-family:InterVar,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(122,108,255,0.08), transparent 6%),
                radial-gradient(1000px 500px at 95% 85%, rgba(94,243,201,0.03), transparent 6%),
                linear-gradient(180deg,var(--bg1),var(--bg2));
    padding:28px;
    color:#eafaf1;
  }

  /* outer card */
  .container{
    width:980px;
    max-width:98vw;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:22px;
    align-items:start;
  }

  /* Left phone card */
  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:18px;
    border:1px solid var(--glass-border);
    box-shadow: var(--neon-shadow);
    backdrop-filter: blur(8px) saturate(140%);
    -webkit-backdrop-filter: blur(8px) saturate(140%);
  }

  .phone-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .brand{font-weight:700;color:var(--accent-2);font-size:18px;letter-spacing:0.4px}
  .status{font-size:13px;color:var(--muted)}

  .display{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:12px;padding:14px;min-height:300px;display:flex;flex-direction:column;gap:10px;
    border:1px solid rgba(255,255,255,0.02);
  }

  .call-header{display:flex;justify-content:space-between;align-items:center}
  .caller-num{font-weight:700;font-size:16px;color:#fff}
  .call-timer{color:var(--accent);font-weight:700;background:linear-gradient(90deg,#072b2a00,#072b2a00);padding:6px 10px;border-radius:999px;border:1px solid rgba(94,243,201,0.08)}

  .ivr-area{flex:1;overflow:auto;padding-right:6px}
  .ivr-msg{background:linear-gradient(90deg, rgba(122,108,255,0.06), rgba(94,243,201,0.03));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;animation:fadeIn .28s ease}
  .ivr-msg .tag{font-size:12px;color:var(--muted);margin-bottom:6px}
  .ivr-msg p{font-size:14px;line-height:1.3;color:#eafaf1}

  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  .keypad{
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;
  }
  .key{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:16px;text-align:center;font-weight:700;cursor:pointer;border:1px solid rgba(255,255,255,0.03);
    transition:transform .08s ease, box-shadow .12s ease;
    box-shadow: 0 6px 22px rgba(11,18,48,0.35);
    color:#fff;font-size:18px;
  }
  .key:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(7,14,30,0.5)}
  .key:active{transform:scale(.98)}
  .key.small{font-size:14px;padding:10px}

  .controls{display:flex;gap:10px;margin-top:14px}
  .btn{
    flex:1;padding:12px;border-radius:12px;border:0;font-weight:800;cursor:pointer;color:#06101a;
    background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:0 10px 30px rgba(122,108,255,0.08);
  }
  .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}

  /* Right panel: details */
  .right{
    display:flex;flex-direction:column;gap:14px;
  }
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:14px;border:1px solid var(--glass-border);box-shadow:var(--neon-shadow);
  }
  .h{font-weight:700;color:var(--accent-2);margin-bottom:8px}
  .muted{color:var(--muted);font-size:13px;margin-bottom:8px}

  .log-list{max-height:300px;overflow:auto;padding-right:6px}
  .log-item{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));font-size:13px}
  .small{font-size:13px;color:var(--muted)}

  .meta-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .meta-pill{background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-weight:700;font-size:13px}

  /* responsive */
  @media (max-width:900px){
    .container{grid-template-columns:1fr;gap:12px;padding:6px}
    .phone{min-height:unset}
  }

</style>
</head>
<body>
  <div class="container">
    <!-- left: IVR phone -->
    <div class="panel">
      <div class="phone-top">
        <div class="brand">IVR â€” Harshvardhan Patil</div>
        <div class="status small" id="sysStatus">Backend: <span style="color:#7af3d1">Checking...</span></div>
      </div>

      <div class="display">
        <div class="call-header">
          <div class="caller-num">+1 336 936 4011</div>
          <div class="call-timer" id="callTimer">00:00</div>
        </div>

        <div class="ivr-area" id="ivrArea">
          <div class="ivr-msg"><div class="tag">System</div><p style="opacity:.85">Press <strong>Start Call</strong> to begin demo session.</p></div>
        </div>

        <div class="keypad" id="keypad" style="pointer-events:none;opacity:.55">
          <div class="key" data-key="1">1</div>
          <div class="key" data-key="2">2<br><small class="small">ABC</small></div>
          <div class="key" data-key="3">3<br><small class="small">DEF</small></div>
          <div class="key" data-key="4">4<br><small class="small">GHI</small></div>
          <div class="key" data-key="5">5<br><small class="small">JKL</small></div>
          <div class="key" data-key="6">6<br><small class="small">MNO</small></div>
          <div class="key" data-key="7">7<br><small class="small">PQRS</small></div>
          <div class="key" data-key="8">8<br><small class="small">TUV</small></div>
          <div class="key" data-key="9">9<br><small class="small">WXYZ</small></div>
          <div class="key small" data-key="*">*</div>
          <div class="key" data-key="0">0<br><small class="small">+</small></div>
          <div class="key small" data-key="#">#</div>
        </div>

        <div class="controls">
          <button id="btnStart" class="btn">ðŸ“ž Start Call</button>
          <button id="btnEnd" class="btn secondary" id="hangupBtn" disabled>ðŸ“µ Hang Up</button>
        </div>
      </div>
    </div>

    <!-- right: logs / meta -->
    <div class="right">
      <div class="card">
        <div class="h">Session & Quick Controls</div>
        <div class="muted">Backend endpoint: <code id="apiUrl" style="color:var(--accent)">http://127.0.0.1:8000</code></div>
        <div class="meta-row">
          <div class="meta-pill" id="activeCalls">Active: 0</div>
          <div class="meta-pill" id="totalCalls">Total: 0</div>
          <div class="meta-pill" id="lastCallId">Last ID: â€”</div>
        </div>
        <div style="height:8px"></div>
        <div class="small">Use the keypad to send DTMF. For PNR test go to Flight Status and enter 6 digits then #.</div>
      </div>

      <div class="card">
        <div class="h">Call Log</div>
        <div class="log-list" id="logList">
          <div class="log-item">No calls yet</div>
        </div>
      </div>

      <div class="card">
        <div class="h">Quick Tips</div>
        <div class="small">1) Make sure backend is running: <code>uvicorn main:app --reload --host 0.0.0.0 --port 8000</code></div>
        <div style="height:6px"></div>
        <div class="small">2) If integrating Twilio later, run <code>ngrok http 8000</code> and map webhook to <code>/voice</code>.</div>
      </div>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const API_BASE_URL = 'https://ai-enabled-conversational-ivr-wn6h.onrender.com';
let callId = null;
let currentMenu = 'main';
let running = false;
let startTs = null;
let timerInt = null;
let recognizing = false;
let recognition;

/* ========== UI shortcuts ========== */
const ivrArea = document.getElementById('ivrArea');
const keypad = document.getElementById('keypad');
const btnStart = document.getElementById('btnStart');
const btnEnd = document.getElementById('btnEnd');
const logList = document.getElementById('logList');
const activeCallsEl = document.getElementById('activeCalls');
const totalCallsEl = document.getElementById('totalCalls');
const lastCallIdEl = document.getElementById('lastCallId');
const sysStatus = document.getElementById('sysStatus');
const callTimer = document.getElementById('callTimer');
const apiUrlEl = document.getElementById('apiUrl');

/* ========== ADD: Mic Button ========== */
const micBtn = document.createElement('button');
micBtn.className = 'btn secondary';
micBtn.textContent = 'ðŸŽ¤ Speak';
micBtn.style.marginTop = '10px';
micBtn.disabled = true;
document.querySelector('.controls').appendChild(micBtn);

/* show API URL */
apiUrlEl.textContent = API_BASE_URL;

/* utility */
function addMessage(text, tag='System'){
  const wrap = document.createElement('div');
  wrap.className = 'ivr-msg';
  wrap.innerHTML = `<div class="tag">${tag}</div><p>${text}</p>`;
  ivrArea.appendChild(wrap);
  ivrArea.scrollTop = ivrArea.scrollHeight;
}

function addLog(text){
  const item = document.createElement('div');
  item.className = 'log-item';
  item.textContent = `${new Date().toLocaleTimeString()} â€” ${text}`;
  if(logList.children[0] && logList.children[0].textContent === 'No calls yet') logList.innerHTML = '';
  logList.prepend(item);
}

/* timer */
function startTimer(){
  startTs = Date.now();
  timerInt = setInterval(()=>{
    const s = Math.floor((Date.now()-startTs)/1000);
    callTimer.textContent = `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  },1000);
}
function stopTimer(){ clearInterval(timerInt); callTimer.textContent='00:00'; }

/* set UI */
function enableKeypad(enable){
  keypad.style.pointerEvents = enable ? 'auto' : 'none';
  keypad.style.opacity = enable ? '1' : '.55';
  btnEnd.disabled = !enable;
  btnStart.disabled = enable;
  micBtn.disabled = !enable;
}

/* backend health check */
async function checkBackend(){
  try{
    const r = await fetch(API_BASE_URL + '/');
    if(!r.ok) throw new Error('no');
    const j = await r.json();
    sysStatus.innerHTML = `Backend: <span style="color:var(--accent)">Online</span>`;
    activeCallsEl.textContent = `Active: ${j.active_calls}`;
    totalCallsEl.textContent = `Total: ${j.total_calls}`;
    return true;
  }catch(e){
    sysStatus.innerHTML = `Backend: <span style="color:#ff9b9b">Offline</span>`;
    return false;
  }
}

/* ======== Start Call ======== */
btnStart.addEventListener('click', startCall);
async function startCall(){
  addMessage('Connecting ...','System');
  enableKeypad(false);
  try{
    const resp = await fetch(API_BASE_URL + '/ivr/start',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ caller_number: '+911111111111' })
    });
    if(!resp.ok) throw new Error('start failed');
    const data = await resp.json();
    callId = data.call_id;
    currentMenu = 'main';
    addMessage(data.prompt, 'IVR');
    speakText(data.prompt); // <=== ADD: speak IVR reply
    addLog(`Connected (id:${callId})`);
    lastCallIdEl.textContent = `Last ID: ${callId}`;
    await refreshMeta();
    enableKeypad(true);
    startTimer();
    running = true;
  }catch(err){
    console.error(err);
    addMessage('Error: could not start session. Check backend.', 'System');
    enableKeypad(false);
    running = false;
  }
}

/* ======== Keypad ======== */
document.querySelectorAll('.key').forEach(k=>{
  k.addEventListener('click', ()=>handleInput(k.getAttribute('data-key')));
});

/* ======== Unified Handler (for keypad or voice) ======== */
async function handleInput(d){
  addMessage(`[You pressed ${d}]`, 'You');
  if(!running || !callId){ addMessage('No active call session. Press Start.', 'System'); return; }

  try{
    const payload = { call_id: callId, digit: String(d), current_menu: currentMenu };
    const r = await fetch(API_BASE_URL + '/ivr/dtmf', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error('dtmf failed');
    const data = await r.json();

    if(data.prompt) { addMessage(data.prompt, 'IVR'); speakText(data.prompt); }

    if(data.current_menu) currentMenu = data.current_menu;
    if(['call_ended','pnr_found','transferring'].includes(data.status)){
      addLog(`Ended (id:${callId})`);
      await finalizeCall();
    }
    await refreshMeta();
  }catch(err){
    console.error(err); addMessage('Network/server error on DTMF','System');
  }
}

/* ======== Speech Recognition ======== */
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-IN';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = ()=>{ recognizing = true; micBtn.textContent = 'ðŸŽ™ï¸ Listening...'; };
  recognition.onend = ()=>{ recognizing = false; micBtn.textContent = 'ðŸŽ¤ Speak'; };
  recognition.onresult = (event)=>{
    const transcript = event.results[0][0].transcript.trim();
    addMessage(`You said: "${transcript}"`, 'You');
    // Try to extract a number if spoken (e.g. "one" -> "1")
    const digitMap = {one:'1',two:'2',three:'3',four:'4',five:'5',six:'6',seven:'7',eight:'8',nine:'9',zero:'0',star:'*',hash:'#'};
    const lower = transcript.toLowerCase();
    const key = digitMap[lower] || lower.match(/[0-9*#]/)?.[0];
    if(key) handleInput(key);
    else addMessage('Could not recognize valid key. Please say a number.', 'System');
  };
}

/* ======== Mic Button ======== */
micBtn.addEventListener('click', ()=>{
  if(!recognition) { alert('Speech recognition not supported on this browser.'); return; }
  if(recognizing){ recognition.stop(); return; }
  recognition.start();
});

/* ======== Text-to-Speech ======== */
function speakText(text){
  if(!window.speechSynthesis) return;
  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = speechSynthesis.getVoices().find(v=>v.lang.startsWith('en-IN')) || null;
  utter.rate = 1.05;
  speechSynthesis.speak(utter);
}

/* ======== Hangup ======== */
btnEnd.addEventListener('click', ()=>endCall(false));
async function endCall(skipBackend=false){
  if(!callId){ finalizeCall(); return; }
  if(!skipBackend){
    try{ await fetch(API_BASE_URL + '/ivr/end?call_id=' + encodeURIComponent(callId), { method:'POST' }); }catch(e){}
  }
  addLog(`User hung up (id:${callId})`);
  await finalizeCall();
}

async function finalizeCall(){
  running = false;
  callId = null;
  currentMenu = 'main';
  enableKeypad(false);
  stopTimer();
  await refreshMeta();
}

/* ======== refresh meta ======== */
async function refreshMeta(){
  try{
    const r = await fetch(API_BASE_URL + '/');
    if(!r.ok) throw new Error();
    const j = await r.json();
    activeCallsEl.textContent = `Active: ${j.active_calls}`;
    totalCallsEl.textContent = `Total: ${j.total_calls}`;
  }catch(e){
    activeCallsEl.textContent = `Active: -`;
    totalCallsEl.textContent = `Total: -`;
  }
}

/* ======== initial health check ======== */
(async ()=>{
  const ok = await checkBackend();
  if(!ok) addMessage('Backend offline: start uvicorn main:app --reload --host 0.0.0.0 --port 8000','System');
  setInterval(refreshMeta,5000);
})();

/* ======== Audio Prompt Tones ======== */
const beepAudio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
const pingAudio = new Audio('https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg');

/* modify recognition start/end */
if (recognition) {
  recognition.onstart = () => {
    recognizing = true;
    micBtn.textContent = 'ðŸŽ™ï¸ Listening...';
    beepAudio.play(); // ðŸ”Š play beep when mic starts
  };
  recognition.onend = () => {
    recognizing = false;
    micBtn.textContent = 'ðŸŽ¤ Speak';
    pingAudio.play(); // ðŸ”Š play ping after system reply
  };
}

/* modify speakText() to play ping before speaking */
function speakText(text){
  if(!window.speechSynthesis) return;
  pingAudio.play(); // ðŸ”Š small ping before system speaks
  const utter = new SpeechSynthesisUtterance(text);
  utter.voice = speechSynthesis.getVoices().find(v=>v.lang.startsWith('en-IN')) || null;
  utter.rate = 1.05;
  speechSynthesis.speak(utter);
}

</script>
</body>
</html>


